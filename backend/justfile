# Prompt Studio Backend - Development Commands
# All commands use 'uv run' to automatically handle the virtual environment

# Start the FastAPI development server
start:
    uv run uvicorn app.main:app --host 127.0.0.1 --port 8000 --reload --reload-dir app

# Stop the FastAPI development server
stop:
    @pkill -f "uvicorn app.main:app" || echo "No server running"
    @pids=$(lsof -t -iTCP:8000 -sTCP:LISTEN 2>/dev/null); if [ -n "$pids" ]; then kill $pids || true; fi

# Run all tests with coverage
test:
    uv run pytest tests/ -v --cov=app

# Run linting with ruff
lint:
    uv run ruff check app/ tests/

# Format code with ruff
format:
    uv run ruff format app/ tests/

# Check formatting without making changes
format-check:
    uv run ruff format --check app/ tests/

# Run database migrations
migrate:
    uv run alembic upgrade head

# Start local PostgreSQL if not already running (macOS/Homebrew)
db:
	@echo "Ensuring Postgres on 127.0.0.1:5432..."
	@pg_isready -q -h 127.0.0.1 -p 5432 2>/dev/null || brew services start postgresql@16 >/dev/null 2>&1 || brew services start postgresql >/dev/null 2>&1 || true
	@pg_isready -q -h 127.0.0.1 -p 5432 2>/dev/null && echo "✓ Postgres running" || (echo "⚠️  Start Postgres manually: brew services start postgresql@16"; exit 1)

# Create a new database migration
migration name:
    uv run alembic revision --autogenerate -m "{{name}}"

# Seed provider content into database
seed:
    uv run python scripts/seed_provider_content.py

# Install/sync dependencies
sync:
    uv sync

# Show available models (requires API running)
models:
    curl http://127.0.0.1:8000/api/models

# Health check (requires API running)
health:
    curl http://127.0.0.1:8000/health

# Clean up all caches and temporary files
clean:
    @echo "Cleaning up caches and temporary files..."
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type f -name "*.pyc" -delete 2>/dev/null || true
    find . -type f -name "*.pyo" -delete 2>/dev/null || true
    find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
    rm -rf htmlcov/ 2>/dev/null || true
    rm -f .coverage 2>/dev/null || true
    rm -f coverage.xml 2>/dev/null || true
    @echo "✓ Cleanup complete!"
